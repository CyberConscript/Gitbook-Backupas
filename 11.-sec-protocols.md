# 11. SEC protocols

## NETWORK ADDRESS ALLOCATION

Most networks use a mixture of static and dynamic address allocation. Interface addresses for routers, firewalls, and some types of servers are best assigned and managed manually. Other server services and client workstations can be assigned dynamic IP configurations and accessed using name resolution.

The Dynamic Host Configuration Protocol (DHCP) provides an automatic method for network address allocation. The key point about DHCP is that only one server should be offering addresses to any one group of hosts. If a rogue DHCP server is set up, it can perform DoS (as client machines will obtain an incorrect TCP/IP configuration) or be used to snoop network information. DHCP starvation is a type of DoS attack where a rogue client repeatedly requests new IP addresses using spoofed MAC addresses, with the aim of exhausting the IP address pool. This makes it more likely that clients seeking an address lease will use the rogue DHCP server.

Enabling the DHCP snooping port security feature on a switch can mitigate rogue DHCP attacks. Windows DHCP servers in an AD environment automatically log any traffic detected from unauthorized DHCP servers. More generally, administration of the DHCP server itself must be carefully controlled and the settings checked regularly. If an attacker compromises the DHCP server, he or she could point network clients to rogue DNS servers and use that as a means to direct users to spoofed websites. Another attack is to redirect traffic through the attacker's machine by changing the default gateway, enabling the attacker to snoop on all network traffic.

DOMAIN NAME RESOLUTION

The Domain Name System (DNS) resolves fully qualified domain names (FQDNs) to IP addresses. It uses a distributed database system that contains information on domains and hosts within those domains. The information is distributed among many name servers, each of which holds part of the database. The name servers work over port 53. Domain name resolution is a security-critical service and the target of many attacks on both local network and the Internet.

#### Domain Hijacking <a href="#dc8b30c2-5a5a-41ef-bf53-80111dd976ce" id="dc8b30c2-5a5a-41ef-bf53-80111dd976ce"></a>

#### Uniform Resource Locator (URL) Redirection <a href="#id-0558c469-1754-486b-8743-f03cee6a24c5" id="id-0558c469-1754-486b-8743-f03cee6a24c5"></a>

A uniform resource locator (URL) is an address for the pages and files published on websites. A URL comprises a FQDN, file path, and often script parameters. URL redirection refers to the use of HTTP redirects to open a page other than the one the user requested. This is often used for legitimate purposes—to send the user to a login page or to send a mobile device browser to a responsive version of the site, for instance. If the redirect is not properly validated by the web application, an attacker can craft a phishing link that might appear legitimate to a naïve user, such as:

https://trusted.foo/login.php?url="https://tru5ted.foo"

A threat actor could also compromise a web server and add redirects in .htaccess files. A redirect could also be inserted as JavaScript, either through compromising the server or by uploading a script via a poorly validated form.

#### Domain Reputation <a href="#b4b54694-48b1-43cc-adb9-908f3d75bcc8" id="b4b54694-48b1-43cc-adb9-908f3d75bcc8"></a>

If your domain, website, or email servers have been hijacked, they are likely to be used for spam or distributing malware. This will lead to complaints and the likelihood of the domain being listed on a block list. You should set up monitoring using a site such as [talosintelligence.com/reputation\_center](https://talosintelligence.com/reputation_center) to detect misuse early.

DNS POISONING

DNS poisoning is an attack that compromises the process by which clients query name servers to locate the IP address for a FQDN. There are several ways that a DNS poisoning attack can be perpetrated.

#### Man in the Middle <a href="#d2aaf287-056d-4f62-b26e-4cace09fd911" id="d2aaf287-056d-4f62-b26e-4cace09fd911"></a>

#### DNS Client Cache Poisoning <a href="#id-401acee4-7264-4488-89ef-1db8a7a3b840" id="id-401acee4-7264-4488-89ef-1db8a7a3b840"></a>

Before DNS was developed in the 1980s, name resolution took place using a text file named HOSTS. Each name:IP address mapping was recorded in this file and system administrators had to download the latest copy and install it on each Internet client or server manually. Even though all name resolution now functions through DNS, the HOSTS file is still present and most operating systems check the file before using DNS. Its contents are loaded into a cache of known name:IP mappings and the client only contacts a DNS server if the name is not cached. Therefore, if an attacker is able to place a false name:IP address mapping in the HOSTS file and effectively poison the DNS cache, he or she will be able to redirect traffic. The HOSTS file requires administrator access to modify. In UNIX and Linux systems it is stored as /etc/hosts, while in Windows it is placed in %SystemRoot%\System32\Drivers\etc\hosts.

#### DNS Server Cache Poisoning <a href="#id-233af759-1a46-4cb7-b514-720a7f397cef" id="id-233af759-1a46-4cb7-b514-720a7f397cef"></a>

DNS server cache poisoning aims to corrupt the records held by the DNS server itself. This can be accomplished by performing DoS against the server that holds the authorized records for the domain, and then spoofing replies to requests from other name servers. Another attack involves getting the victim name server to respond to a recursive query from the attacking host. A recursive query compels the DNS server to query the authoritative server for the answer on behalf of the client. The attacker's DNS, masquerading as the authoritative name server, responds with the answer to the query, but also includes a lot of false domain:IP mappings for other domains that the victim DNS accepts as genuine. The nslookup or dig tool can be used to query the name records and cached records held by a server to discover whether any false records have been inserted.

DNS SECURITY

DNS is a critical service that should be configured to be fault tolerant. DoS attacks are hard to perform against the servers that perform Internet name resolution, but if an attacker can target the DNS server on a private network, it is possible to seriously disrupt the operation of that network.

To ensure DNS security on a private network, local DNS servers should only accept recursive queries from local hosts (preferably authenticated local hosts) and not from the Internet. You also need to implement access control measures on the server, to prevent a malicious user from altering records manually. Similarly, clients should be restricted to using authorized resolvers to perform name resolution.

Attacks on DNS may also target the server application and/or configuration. Many DNS services run on BIND (Berkeley Internet Name Domain), distributed by the Internet Software Consortium ([isc.org](https://www.isc.org/)). There are known vulnerabilities in many versions of the BIND server, so it is critical to patch the server to the latest version. The same general advice applies to other DNS server software, such as Microsoft's. Obtain and check security announcements and then test and apply critical and security-related patches and upgrades.

DNS footprinting means obtaining information about a private network by using its DNS server to perform a zone transfer (all the records in a domain) to a rogue DNS or simply by querying the DNS service, using a tool such as nslookup or dig. To prevent this, you can apply an Access Control List to prevent zone transfers to unauthorized hosts or domains, to prevent an external server from obtaining information about the private network architecture.

DNS Security Extensions (DNSSEC) help to mitigate against spoofing and poisoning attacks by providing a validation process for DNS responses. With DNSSEC enabled, the authoritative server for the zone creates a "package" of resource records (called an RRset) signed with a private key (the Zone Signing Key). When another server requests a secure record exchange, the authoritative server returns the package along with its public key, which can be used to verify the signature.

The public zone signing key is itself signed with a separate Key Signing Key. Separate keys are used so that if there is some sort of compromise of the zone signing key, the domain can continue to operate securely by revoking the compromised key and issuing a new one.

The Key Signing Key for a particular domain is validated by the parent domain or host ISP. The top-level domain trusts are validated by the Regional Internet Registries and the DNS root servers are self-validated, using a type of M-of-N control group key signing. This establishes a chain of trust from the root servers down to any particular subdomain.

SECURE DIRECTORY SERVICES

A network directory lists the subjects (principally users, computers, and services) and objects (such as directories and files) available on the network plus the permissions that subjects have over objects. A network directory facilitates authentication and authorization, and it is critical that it be maintained as a highly secure service. Most directory services are based on the Lightweight Directory Access Protocol (LDAP), running over port 389. The basic protocol provides no security and all transmissions are in plaintext, making it vulnerable to sniffing and man-in-the-middle attacks. Authentication (referred to as binding to the server) can be implemented in the following ways:

* No authentication—anonymous access is granted to the directory.
* Simple bind—the client must supply its distinguished name (DN) and password, but these are passed as plaintext.
* Simple Authentication and Security Layer (SASL)—the client and server negotiate the use of a supported authentication mechanism, such as Kerberos. The STARTTLS command can be used to require encryption (sealing) and message integrity (signing). This is the preferred mechanism for Microsoft's Active Directory (AD) implementation of LDAP.
* LDAP Secure (LDAPS)—the server is installed with a digital certificate, which it uses to set up a secure tunnel for the user credential exchange. LDAPS uses port 636.

If secure access is required, anonymous and simple authentication access methods should be disabled on the server.

Generally two levels of access will need to be granted on the directory: read-only access (query) and read/write access (update). This is implemented using an access control policy, but the precise mechanism is vendor-specific and not specified by the LDAP standards documentation.

Unless hosting a public service, the LDAP directory server should also only be accessible from the private network. This means that the LDAP port should be blocked by a firewall from access over the public interface. If there is integration with other services over the Internet, ideally only authorized IPs should be permitted.

TIME SYNCHRONIZATION

Many applications on networks are time dependent and time critical. These include authentication and security mechanisms, scheduling applications, and backup software. The Network Time Protocol (NTP) provides a transport over which to synchronize these time dependent applications. NTP works over UDP on port 123.

Top-level NTP servers (stratum 1) obtain the Coordinated Universal Time (UTC) from a highly accurate clock source, such as an atomic clock. Lower tier servers then obtain the UTC from multiple stratum 1 servers and sample the results to obtain an authoritative time. Most organizations will use a stratum 2 server to obtain the time for use on the LAN. Servers at lower tiers may then perform the same sort of sampling operation, adjust for the delay involved in propagating the signal, and provide the time to clients. Clients themselves usually obtain the time using a modified form of the protocol (Simple NTP).

NTP has historically lacked any sort of security mechanism, but there are moves to create a security extension for the protocol called Network Time Security ([blog.cloudflare.com/secure-time](https://blog.cloudflare.com/secure-time/)).

## SIMPLE NETWORK MANAGEMENT PROTOCOL SECURITY

The Simple Network Management Protocol (SNMP) is a widely used framework for management and monitoring. SNMP consists of an SNMP monitor and agents. Protocol for monitoring and managing network devices. SNMP works over UDP ports 161 and 162 by default.

* The agent is a process (software or firmware) running on a switch, router, server, or other SNMP-compatible network device.
* This agent maintains a database called a management information base (MIB) that holds statistics relating to the activity of the device (for example, the number of frames per second handled by a switch). The agent is also capable of initiating a trap operation where it informs the management system of a notable event (port failure, for instance). The threshold for triggering traps can be set for each value. Device queries take place over port 161 (UDP); traps are communicated over port 162 (also UDP).
* The SNMP monitor (a software program) provides a location from which network activity can be overseen. It monitors all agents by polling them at regular intervals for information from their MIBs and displays the information for review. It also displays any trap operations as alerts for the network administrator to assess and act upon as necessary.

If SNMP is not used, you should remember to change the default configuration password and disable it on any SNMP-capable devices that you add to the network. If you are running SNMP v1 or v2c, keep to the following guidelines:

* SNMP community names are sent in plaintext and so should not be transmitted over the network if there is any risk that they could be intercepted. SNMP community strings are an authentication mechanism which gives access to a network device's statistics.
* Use difficult-to-guess community names; never leave the community name blank or set to the default.
* Use Access Control Lists to restrict management operations to known hosts (that is, restrict to one or two host IP addresses).
* SNMP v3 supports encryption and strong user-based authentication. Instead of community names, the agent is configured with a list of usernames and access permissions. When authentication is required, the SNMP message is signed with a hash of the user's passphrase. The agent can verify the signature and authenticate the user using its own record of the passphrase.

## HYPERTEXT TRANSFER PROTOCOL AND WEB SERVICES

The foundation of web technology is the HyperText Transfer Protocol (HTTP). HTTP enables clients (typically web browsers) to request resources from an HTTP server. A client connects to the HTTP server using an appropriate TCP port (the default is port 80) and submits a request for a resource, using a uniform resource locator (URL). The server acknowledges the request and responds with the data (or an error message).

The response and request payload formats are defined in an HTTP header. The HTTP payload is usually used to serve HTML web pages, which are plaintext files with coded tags (HyperText Markup Language) describing how the page should be formatted. A web browser can interpret the tags and display the text and other resources associated with the page, such as binary picture or sound files linked to the HTML page.

HTTP also features a forms mechanism (POST) whereby a user can submit data from the client to the server. HTTP is nominally a stateless protocol; this means that the server preserves no information about the client during a session. However, the basic functionality of HTTP servers is often extended by support for scripting and programmable features (web applications). Servers can also set text file cookies to preserve session information. These coding features, plus integration with databases, increase flexibility and interactivity, but also increase the attack surface which exposes more vulnerabilities.

## TRANSPORT LAYER SECURITY

As with other early TCP/IP application protocols, HTTP communications are not secured. Secure Sockets Layer (SSL) was developed by Netscape in the 1990s to address the lack of security in HTTP. SSL proved very popular with the industry, and it was quickly adopted as a standard named Transport Layer Security (TLS). It is typically used with HTTP (referred to as HTTPS or HTTP Secure) but can also be used to secure other application protocols and as a virtual private networking (VPN) solution.

To implement TLS, a server is assigned a digital certificate signed by some trusted certificate authority (CA). The certificate proves the identity of the server (assuming that the client trusts the CA) and validates the server's public/private key pair. The server uses its key pair and the TLS protocol to agree upon mutually supported ciphers with the client and negotiate an encrypted communications session.

#### SSL/TLS Versions <a href="#d613d5ce-1fb0-465b-96f7-86089ff5178c" id="d613d5ce-1fb0-465b-96f7-86089ff5178c"></a>

While the acronym SSL is still used, the Transport Layer Security versions are the only ones that are safe to use. A server can provide support for legacy clients, but obviously this is less secure. For example, a TLS 1.2 server could be configured to allow clients to downgrade to TLS 1.1 or 1.0 or even SSL 3.0 if they do not support TLS 1.2.

TLS version 1.3 was approved in 2018. One of the main features of TLS 1.3 is the removal of the ability to perform downgrade attacks by preventing the use of unsecure features and algorithms from previous versions. There are also changes to the handshake protocol to reduce the number of messages and speed up connections.

## Cipher Suites <a href="#id-23cfbc68-7b38-45b6-aab9-c4d754a8ed3d" id="id-23cfbc68-7b38-45b6-aab9-c4d754a8ed3d"></a>

A cipher suite is the group of algorithms supported by both the client and server to perform the different encryption and hashing operations required by the protocol. Prior to TLS 1.3, a cipher suite would be written in the following form:

ECDHE-RSA-AES128-GCM-SHA256

This means that the server can use Elliptic Curve Diffie-Hellman Ephemeral mode for session key agreement, RSA signatures, 128-bit AES-GCM (Galois Counter Mode) for symmetric bulk encryption, and 256-bit SHA for HMAC functions. Suites the server prefers are listed earlier in its supported cipher list.

TLS 1.3 uses simplified and shortened suites. A typical TLS 1.3 cipher suite appears as follows:

TLS\_AES\_256\_GCM\_SHA384

Only ephemeral key agreement is supported in 1.3 and the signature type is supplied in the certificate, so the cipher suite only lists the bulk encryption key strength and mode of operation (AES\_256\_GCM), plus the cryptographic hash algorithm (SHA384) used within the new hash key derivation function (HKDF). HKDF is the mechanism by which the shared secret established by Diffie Hellman key agreement is used to derive symmetric session keys.

## API CONSIDERATIONS

HTTP is now used less to serve static web pages, and more to create web applications, often as part of a cloud product. An enterprise might use both public web applications over the Internet and private ones. The primary means of configuring and managing a web application is via its application programming interface (API). For example, an application might allow a user account to be created via a URL:

https://example.foo/api/users?api\_key=123456

The developer uses the POST method to submit data to the URL with the required parameters coded into the request body, often in JavaScript Object Notation (JSON).

POST /api/users HTTP/1.1

Content-Type: application/json

{

"user": {

"name": "James",

"email": "jpengelly@comptia.org"

}

}

Use of these APIs is authorized via a token or secret key. Effective management of these API secrets is a key consideration in modern networks, as they have been widely used to perpetrate various breaches and data thefts. For example, putting the key in the URL carries a severe risk of exposure. APIs can use more secure authentication and authorization methods, such as SAML and OAuth, but these still come with secrets management requirements. Another API consideration is that usage should be monitored to ensure only authorized endpoints are making transactions.

## SUBSCRIPTION SERVICES

Employees may require access to all kinds of subscription services. Some examples include:

* Market and financial intelligence and information.
* Security threat intelligence and information.
* Reference and training materials in various formats (ebook and video, for instance).
* Software applications and cloud services paid for by subscription rather than permanent licenses.

Most of this sort of content will be delivered by a secure web site or cloud application. It may be necessary to provision authentication mechanisms for enterprise single sign-on (SSO) access to the services.

Another use of subscriptions is a web feed, where updated articles or news items are pushed to the client or browser. Web feeds are based on either the Really Simple Syndication (RSS) or Atom formats, both of which use XML to mark up each document supplied by the feed. It is possible that such feeds may be vulnerable to XML injection style attacks, allowing an attacker to show malicious links or even interact with the file system ([https://mikeknoop.com/lxml-xxe-exploit](https://mikeknoop.com/lxml-xxe-exploit)).

## FILE TRANSFER SERVICES

There are many means of transferring files across networks. A network operating system can host shared folders and files, enabling them to be copied or accessed over the local network or via remote access (over a VPN, for instance). Email and messaging apps can send files as attachments. HTTP supports file download (and uploads via various scripting mechanisms). There are also peer-to-peer file sharing services. Despite the availability of these newer protocols and services, the file transfer protocol (FTP) remains very popular because it is efficient and has wide cross-platform support.

#### File Transfer Protocol <a href="#id-84b20094-4e6d-4bd3-b7f3-0e950d030feb" id="id-84b20094-4e6d-4bd3-b7f3-0e950d030feb"></a>

A File Transfer Protocol (FTP) server is typically configured with several public directories, hosting files, and user accounts. Most HTTP servers also function as FTP servers, and FTP services, accounts, and directories may be installed and enabled by default when you install a web server. FTP is more efficient compared to file attachments or HTTP file transfer, but has no security mechanisms. All authentication and data transfer are communicated as plaintext, meaning that credentials can easily be picked out of any intercepted FTP traffic.

You should check that users do not install unauthorized servers on their PCs (a rogue server). For example, a version of IIS that includes HTTP, FTP, and SMTP servers is shipped with client versions of Windows, though it is not installed by default.

#### SSH FTP (SFTP) and FTP Over SSL (FTPS) <a href="#id-688a162e-b066-40e9-b019-7e0b25efcfc3" id="id-688a162e-b066-40e9-b019-7e0b25efcfc3"></a>

SSH FTP (SFTP) addresses the privacy and integrity issues of FTP by encrypting the authentication and data transfer between client and server. In SFTP, a secure link is created between the client and server using Secure Shell (SSH) over TCP port 22. Ordinary FTP commands and data transfer can then be sent over the secure link without risk of eavesdropping or man-in-the-middle attacks. This solution requires an SSH server that supports SFTP and SFTP client software.

Another means of securing FTP is to use the connection security protocol SSL/TLS. There are two means of doing this:

Explicit TLS (FTPES)—use the AUTH TLS command to upgrade an unsecure connection established over port 21 to a secure one. This protects authentication credentials. The data connection for the actual file transfers can also be encrypted (using the PROT command). Implicit TLS (FTPS)—negotiate an SSL/TLS tunnel before the exchange of any FTP commands. This mode uses the secure port 990 for the control connection. FTPS is tricky to configure when there are firewalls between the client and server. Consequently, FTPES is usually the preferred method.

EMAIL SERVICES

Email services use two types of protocols:

* The Simple Mail Transfer Protocol (SMTP) transmits email messages from one system to another.
* The Post Office Protocol v3 (POP3) receives email messages from an email server to store on a client computer.

#### Secure SMTP (SMTPS) <a href="#id-50791cb8-9e59-4431-ab1a-94bac8208816" id="id-50791cb8-9e59-4431-ab1a-94bac8208816"></a>

A sender’s SMTP server discovers the IP address of the recipient’s SMTP server using the domain name of the recipient’s email address. The SMTP server for the domain is registered in DNS using a Mail Exchanger (MX) record.

SMTP communications can be secured using TLS. This works much like HTTPS with a certificate on the SMTP server. There are two ways for SMTP to use TLS:

* STARTTLS—this is a command that upgrades an existing unsecure connection to use TLS. This is also referred to as explicit TLS or opportunistic TLS.
* SMTPS—this establishes the secure connection before any SMTP commands (HELO, for instance) are exchanged. This is also referred to as implicit TLS.

The STARTTLS method is generally more widely implemented than SMTPS. Typical SMTP configurations use the following ports and secure services:

* Port 25—used for message relay (between SMTP servers or Message Transfer Agents \[MTA]). If security is required and supported by both servers, the STARTTLS command can be used to set up the secure connection.
* Port 587—used by mail clients (Message Submission Agents \[MSA]) to submit messages for delivery by an SMTP server. Servers configured to support port 587 should use STARTTLS and require authentication before message submission.
* Port 465—some providers and mail clients use this port for message submission over implicit TLS (SMTPS), though this usage is now deprecated by standards documentation.

#### Secure SMTP (SMTPS) <a href="#id-50791cb8-9e59-4431-ab1a-94bac8208816" id="id-50791cb8-9e59-4431-ab1a-94bac8208816"></a>

A sender’s SMTP server discovers the IP address of the recipient’s SMTP server using the domain name of the recipient’s email address. The SMTP server for the domain is registered in DNS using a Mail Exchanger (MX) record.

SMTP communications can be secured using TLS. This works much like HTTPS with a certificate on the SMTP server. There are two ways for SMTP to use TLS:

* STARTTLS—this is a command that upgrades an existing unsecure connection to use TLS. This is also referred to as explicit TLS or opportunistic TLS.
* SMTPS—this establishes the secure connection before any SMTP commands (HELO, for instance) are exchanged. This is also referred to as implicit TLS.

The STARTTLS method is generally more widely implemented than SMTPS. Typical SMTP configurations use the following ports and secure services:

* Port 25—used for message relay (between SMTP servers or Message Transfer Agents \[MTA]). If security is required and supported by both servers, the STARTTLS command can be used to set up the secure connection.
* Port 587—used by mail clients (Message Submission Agents \[MSA]) to submit messages for delivery by an SMTP server. Servers configured to support port 587 should use STARTTLS and require authentication before message submission.
* Port 465—some providers and mail clients use this port for message submission over implicit TLS (SMTPS), though this usage is now deprecated by standards documentation.

#### Secure POP (POP3S) <a href="#id-99c71351-4c21-4190-8c12-235b661b4c1c" id="id-99c71351-4c21-4190-8c12-235b661b4c1c"></a>

When a recipient’s email client connects to a server mailbox, POP3 downloads the email messages.

A POP3 client application, such as Microsoft Outlook or Mozilla Thunderbird, establishes a TCP connection to the POP3 server over port 110. The user is authenticated (by username and password) and the contents of his or her mailbox are downloaded for processing on the local PC. POP3S is the secured version of the protocol, operating over TCP port 995 by default.

#### Secure IMAP (IMAPS) <a href="#f56d0842-04c7-4be8-8962-691a37f9686d" id="f56d0842-04c7-4be8-8962-691a37f9686d"></a>

Compared to POP3, the Internet Message Access Protocol v4 (IMAP4) supports permanent connections to a server and connecting multiple clients to the same mailbox simultaneously. It also allows a client to manage mail folders on the server. Clients connect to IMAP over TCP port 143. They authenticate themselves then retrieve messages from the designated folders. As with other email protocols, the connection can be secured by establishing an SSL/TLS tunnel. The default port for IMAPS is TCP port 993.

## SECURE/MULTIPURPOSE INTERNET MAIL EXTENSIONS

Connection security goes a long way toward preventing the compromise of email accounts and the spoofing of email, but end-to-end encryption cannot usually be guaranteed. Consequently, there is still a need for authentication and confidentiality to be applied on a per-message basis. One means of doing this is called Secure/Multipurpose Internet Mail Extensions (S/MIME). To use S/MIME, the user is issued a digital certificate containing his or her public key, signed by a CA to establish its validity. The public key is a pair with a private key kept secret by the user. To establish the exchange of secure emails, both users must be using S/MIME and exchange certificates:

1. Alice sends Bob her digital certificate, containing her public key and validated digital ID (an email address). She signs this message using her private key.
2. Bob uses the public key in the certificate to decode her signature and the signature of the CA (or chain of CAs) validating her digital certificate and digital ID and decides that he can trust Alice and her email address.
3. He responds with his digital certificate and public key and Alice, following the same process, decides to trust Bob.
4. Both Alice and Bob now have one another's certificates in their trusted certificate stores.
5. When Alice wants to send Bob a confidential message, she makes a hash of the message and signs the hash using her private key. She then encrypts the message, hash, and her public key using Bob's public key and sends a message to Bob with this data as an S/MIME attachment.
6. Bob receives the message and decrypts the attachment using his private key. He validates the signature and the integrity of the message by decrypting it with Alice's public key and comparing her hash value with one he makes himself.

## VOICE AND VIDEO SERVICES

Voice over IP (VoIP), web conferencing, and video teleconferencing (VTC) solutions have become standard methods for the provision of business communications. The main challenges that these applications have in common is that they transfer real-time data and must create point-to-point links between hosts on different networks.

Implementing Internet telephony and video conferencing brings its own raft of security concerns. Each part of the communications media network infrastructure needs to be evaluated for threats and vulnerabilities. This includes protocols, servers, handsets, and software. The protocols designed to support real-time services cover one or more of the following functions:

* Session control—used to setup and manage communications sessions. They handle tasks such as user discovery (locating a user on the network), availability advertising (whether a user is prepared to receive calls), negotiating session parameters (such as use of audio/video), and session management and termination.
* Data transport—handles the delivery of the actual video or voice information.
* Quality of Service (QoS)—provides information about the connection to a QoS system, which in turn ensures that voice or video communications are free from problems such as dropped packets, delay, or jitter.

The Session Initiation Protocol (SIP) is one of the most widely used session control protocols. SIP endpoints are the end-user devices (also known as user-agents), such as IP-enabled handsets or client and server web conference software. Each device, conference, or telephony user is assigned a unique SIP address known as a SIP Uniform Resource Indicator (URI), such as sip:bob.dobbs@comptia.org

SIP endpoints can establish communications directly in a peer-to-peer architecture, but it is more typical to use intermediary servers and directory servers. A SIP network may also use gateways and private branch exchange (PBX) appliances to provide an interface between the VoIP network and external telephone and cellular networks.

While SIP provides session management features, the actual delivery of real-time data uses different protocols. The principal one is Real-time Transport Protocol (RTP).

A threat actor could exploit unencrypted voice and video communications to try to intercept passwords, credit card details, and so on. Without strong mutual authentication, connections are also vulnerable to man-in-the-middle attacks.

Connection security for voice and video works in a similar manner to HTTPS. To initiate the call, the secure version SIPS uses digital certificates to authenticate the endpoints and establish a TLS tunnel. Where unencrypted SIP typically runs over TCP port 5060, SIPS uses TCP port 5061. The secure connection established by SIPS can also be used to generate a master key to use with the secure versions of the transport protocol (SRTP). SRTP provides confidentiality for the actual call data.

## Implement Secure Remote Access Protocols

With today's mobile workforce, most networks have to support connections by remote employees, contractors, and customers to their network resources. These remote connections often make use of untrusted public networks, such as the Internet. Consequently, understanding how to implement secure remote access protocols will be a major part of your job as an information security professional.

There are also many cases where a user needs to remotely access an individual host. This is most commonly implemented to allow administrators to perform remote management of workstations, servers, and network appliances, but it can also be used to provide ordinary users access to a desktop as well.

## REMOTE ACCESS ARCHITECTURE

Remote access means that the user's device does not make a direct cabled or wireless connection to the network. The connection occurs over or through an intermediate network. Historically, remote access might have used analog modems connecting over the telephone system or possibly a private link (a leased line). These days, most remote access is implemented as a virtual private network (VPN), running over the Internet. Administering remote access involves essentially the same tasks as administering the local network. Only authorized users should be allowed access to local network resources and communication channels. Additional complexity comes about because it can be more difficult to ensure the security of remote workstations and servers and there is greater opportunity for remote logins to be exploited.

With a remote access VPN, clients connect to a VPN gateway on the edge of the private network. This is the "telecommuter" model, allowing home-workers and employees working in the field to connect to the corporate network. The VPN protocol establishes a secure tunnel so that the contents are kept private, even when the packets pass over ISPs' routers.

#### Internet Access

While legacy dial-up methods still have some uses, most remote access connections use virtual private networking (VPN).

The first step is for the VPN client to connect to the gateway over the Internet. The client can use any method to make this connection.

This initial connection is vulnerable to man-in-the-middle if made over an unsecure network, such as an open Wi-Fi network.

#### VPN Gateway

The enterprise network places a VPN gateway at the network edge, typically protected by DMZ filtering. The VPN gateway should be configured with some type of certificate, so that the client can trust that it is connecting to a secure service, even if the Internet connection is untrusted.

When the client connects, the VPN gateway authenticates the user (typically using an AAA server) and creates an encrypted tunnel for the client. No one with access to the network facilitating Internet access can snoop on the tunneled traffic.

A VPN can also be deployed in a site-to-site model to connect two or more private networks. Where remote access VPN connections are typically initiated by the client, a site-to-site VPN is configured to operate automatically. The gateways exchange security information using whichever protocol the VPN is based on. This establishes a trust relationship between the gateways and sets up a secure connection through which to tunnel data. Hosts at each site do not need to be configured with any information about the VPN. The routing infrastructure at each site determines whether to deliver traffic locally or send it over the VPN tunnel.

## TRANSPORT LAYER SECURITY VPN

Several VPN protocols have been used over the years. Legacy protocols such as the Point-to-Point Tunneling Protocol (PPTP) have been deprecated because they do not offer adequate security. Transport Layer Security (TLS) and IPSec are now the preferred options for configuring VPN access.

A TLS VPN (still more commonly referred to as an SSL VPN) requires a remote access server listening on port 443 (or any arbitrary port number). The client makes a connection to the server using TLS so that the server is authenticated to the client (and optionally the client's certificate must be authenticated by the server). This creates an encrypted tunnel for the user to submit authentication credentials, which would normally be processed by a RADIUS server. Once the user is authenticated and the connection fully established, the VPN gateway tunnels all communications for the local network over the secure socket.

OpenVPN is an open source example of a TLS VPN ([openvpn.net](https://openvpn.net/)). OpenVPN can work in TAP (bridged) mode to tunnel layer 2 frames or in TUN (routed) mode to forward IP packets. Another option is Microsoft's Secure Socket Tunneling Protocol (SSTP), which works by tunneling Point-to-Point Protocol (PPP) layer 2 frames over a TLS session ([docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-sstp/70adc1df-c4fe-4b02-8872-f1d8b9ad806a](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sstp/70adc1df-c4fe-4b02-8872-f1d8b9ad806a)). The Point-to-Point Protocol (PPP) is a widely used remote dial-in protocol. It provides encapsulation for IP traffic plus IP address assignment and authentication via the widely supported Challenge Handshake Authentication Protocol (CHAP).

## INTERNET PROTOCOL SECURITY

Transport Layer Security is applied at the application level, either by using a separate secure port or by using commands in the application protocol to negotiate a secure connection. Internet Protocol Security (IPSec) operates at the network layer (layer 3) of the OSI model, so it can be implemented without having to configure specific application support. IPSec can provide both confidentiality (by encrypting data packets) and integrity/anti-replay (by signing each packet). The main drawback is that it adds overhead to data communications. IPSec can be used to secure communications on local networks and as a remote access protocol.\
When IPv6 was being drafted, IPSec was considered a mandatory component as it was felt that all traffic over the new protocol should be secure. In recent years, RFCs have been revised so that now, IPSec is recommended for IPv6 but no longer mandatory ([tools.ietf.org/html/rfc6434#page-17](https://tools.ietf.org/html/rfc6434#page-17)).

Each host that uses IPSec must be assigned a policy. An IPSec policy sets the authentication mechanism and also the protocols and mode for the connection. Hosts must be able to match at least one matching security method for a connection to be established. There are two core protocols in IPSec, which can be applied singly or together, depending on the policy.

#### Authentication Header (AH) <a href="#d0f5949d-3227-41ce-bca1-baba4cd0a0ef" id="d0f5949d-3227-41ce-bca1-baba4cd0a0ef"></a>

An IPSec protocol that provides authentication for the origin of transmitted data as well as integrity and protection against replay attacks.

The Authentication Header (AH) protocol performs a cryptographic hash on the whole packet, including the IP header, plus a shared secret key (known only to the communicating hosts), and adds this HMAC in its header as an Integrity Check Value (ICV). The recipient performs the same function on the packet and key and should derive the same value to confirm that the packet has not been modified. The payload is not encrypted so this protocol does not provide confidentiality. Also, the inclusion of IP header fields in the ICV means that the check will fail across NAT gateways, where the IP address is rewritten. Consequently, AH is not often used.

#### Encapsulation Security Payload (ESP) <a href="#id-9779840d-1e1b-475b-8a31-09bfd465f23d" id="id-9779840d-1e1b-475b-8a31-09bfd465f23d"></a>

Encapsulation Security Payload (ESP) (IPSec sub-protocol that enables encryption and authentication of the header and payload of a data packet) provides confidentiality and/or authentication and integrity. It can be used to encrypt the packet rather than simply calculating an HMAC. ESP attaches three fields to the packet: a header, a trailer (providing padding for the cryptographic function), and an Integrity Check Value. Unlike AH, ESP excludes the IP header when calculating the ICV.

With ESP, algorithms for both confidentiality (symmetric cipher) and authentication/integrity (hash function) are usually applied together. It is possible to use one or the other, however.

## IPSEC TRANSPORT AND TUNNEL MODES

IPSec can be used in two modes:

* Transport mode—this mode is used to secure communications between hosts on a private network (an end-to-end implementation). When ESP is applied in transport mode, the IP header for each packet is not encrypted, just the payload data. If AH is used in transport mode, it can provide integrity for the IP header.

<figure><img src="https://s3.amazonaws.com/wmx-api-production/courses/5731/images/4255-1599771806237.png" alt="There are 4 blocks in a row: IP Header, AH (which contains a  block named ICV), ESP (which contains 2 blocks named TCP/UDP and Payload), and Trailer."><figcaption></figcaption></figure>

* Tunnel mode—this mode is used for communications between VPN gateways across an unsecure network (creating a VPN). This is also referred to as a router implementation. With ESP, the whole IP packet (header and payload) is encrypted and encapsulated as a datagram with a new IP header. AH has no real use case in tunnel mode, as confidentiality will usually be required.

<figure><img src="https://s3.amazonaws.com/wmx-api-production/courses/5731/images/9959-1599771806294.png" alt="There are 4 blocks in a row: New IP Header, ESP (which contains a block with the original encapsulated packet), Trailer, and ICV."><figcaption></figcaption></figure>

<figure><img src="https://s3.amazonaws.com/wmx-api-production/courses/5731/images/6158-1599771806356.png" alt="VPN > Mobile Clients configuration page showing Tunnel IPv4 selected for Mode and ESP selected under Phase 2 Proposal Protocol."><figcaption></figcaption></figure>

The principles underlying IPSec are the same for IPv4 and IPv6, but the header formats are different. IPSec makes use of extension headers in IPv6 while in IPv4, ESP and AH are allocated new IP protocol numbers (50 and 51), and either modify the original IP header or encapsulate the original packet, depending on whether transport or tunnel mode is used.

INTERNET KEY EXCHANGE

IPSec's encryption and hashing functions depend on a shared secret. The secret must be communicated to both hosts and the hosts must confirm one another's identity (mutual authentication). Otherwise, the connection is vulnerable to man-in-the-middle and spoofing attacks. The Internet Key Exchange (IKE) protocol handles authentication and key exchange, referred to as Security Associations (SA). Framework for creating a Security Association (SA) used with IPSec. An SA establishes that two hosts trust one another (authenticate) and agree secure protocols and cipher suites to use to exchange data.

IKE negotiations take place over two phases:

1. Phase I establishes the identity of the two hosts and performs key agreement using the Diffie-Hellman algorithm to create a secure channel. Two methods of authenticating hosts are commonly used:
   * Digital certificates—the hosts use certificates issued by a mutually trusted certificate authority to identify one another.
   * Pre-shared key (group authentication)—the same passphrase is configured on both hosts.
2. Phase II uses the secure channel created in Phase I to establish which ciphers and key sizes will be used with AH and/or ESP in the IPSec session.

## LAYER 2 TUNNELING PROTOCOL AND IKE V2

This first version of IKE is optimized to ensure the mutual authentication of two peer hosts, such as in a site-to-site VPN. On its own, it does not provide a simple means for a client user account to authenticate to a remote network directory. Consequently, for remote access VPNs, a combination of IPSec with the Layer 2 Tunneling Protocol (L2TP) VPN protocol is often used.

VPN protocol for tunneling PPP sessions across a variety of network protocols such as IP, Frame Relay, or ATM.

#### Layer 2 Tunneling Protocol/IPSec VPN <a href="#db216582-a695-4207-bee0-e080d5b142ba" id="db216582-a695-4207-bee0-e080d5b142ba"></a>

A L2TP/IPSec VPN would typically operate as follows:

1. The client and VPN gateway set up a secure IPSec channel over the Internet, using either a pre-shared key or certificates for IKE.
2. The VPN gateway uses L2TP to set up a tunnel to exchange local network data encapsulated as Point-to-Point Protocol (PPP) frames. This double encapsulation of traffic is the main drawback, as it adds overhead.
3. The user authenticates over the PPP session using EAP or CHAP.

#### IKE v2 <a href="#id-53d319ac-1d44-4897-9fb5-1a2c0bc2f88a" id="id-53d319ac-1d44-4897-9fb5-1a2c0bc2f88a"></a>

The drawbacks of the original version of IKE were addressed by an updated protocol. IKE v2 has some additional features that have made the protocol popular for use as a standalone remote access VPN solution. The main changes are:

* Support for EAP authentication methods, allowing, for example, user authentication against a RADIUS server.
* Simplified connection set up—IKE v2 specifies a single 4-message setup mode, reducing bandwidth without compromising security.
* Reliability—IKE v2 allows NAT traversal and MOBIKE multihoming. Multihoming means that a client such as a smartphone with multiple interfaces (such as Wi-Fi and cellular) can keep the IPSec connection alive when switching between them.

Compared to L2TP/IPSec, using IKE v2 is more efficient. This solution is becoming much better supported, with native support in Windows 10, for instance.

## VPN CLIENT CONFIGURATION

To configure a VPN client, you may need to install the client software if the VPN type is not natively supported by the OS. For example, OpenVPN requires client installation. You then configure the client with the address of the VPN gateway, the VPN protocol type (if it cannot autodetect it), the username, and the account credentials. You may also need to deploy a client certificate that is trusted by the VPN concentrator to the machine and make that available to the VPN client. In addition, you might need to configure settings for how the VPN connection operates.

#### Always-On VPN <a href="#id-9dfd7e58-0922-4867-a4be-1a65f75c1fe1" id="id-9dfd7e58-0922-4867-a4be-1a65f75c1fe1"></a>

Traditional remote access VPN solutions require the user to initiate the connection and enter their authentication credentials. An always-on VPN means that the computer establishes the VPN whenever an Internet connection over a trusted network is detected, using the user's cached credentials to authenticate. Microsoft has an Always-On VPN solution for Windows Server and Windows 10 clients ([docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/always-on-vpn/deploy/always-on-vpn-deploy-deployment](https://docs.microsoft.com/en-us/windows-server/remote/remote-access/vpn/always-on-vpn/deploy/always-on-vpn-deploy-deployment)) and an OpenVPN client can be configured to autoconnect ([openvpn.net/vpn-server-resources/setting-your-client-to-automatically-connect-to-your-vpn-when-your-computer-starts](https://openvpn.net/vpn-server-resources/setting-your-client-to-automatically-connect-to-your-vpn-when-your-computer-starts/)).

#### Split Tunnel versus Full Tunnel <a href="#b150240b-badc-4016-aafd-90a85b233fd5" id="b150240b-badc-4016-aafd-90a85b233fd5"></a>

When a client connected to a remote access VPN tries to access other sites on the Internet, there are two ways to manage the connection:

* Split tunnel—the client accesses the Internet directly using its "native" IP configuration and DNS servers.
*   Full tunnel—Internet access is mediated by the corporate network, which will alter the client's IP address and DNS servers and may use a proxy.

    Full tunnel offers better security, but the network address translations and DNS operations required may cause problems with some websites, especially cloud services. It also means more data is channeled over the link.

## REMOTE DESKTOP

A remote access VPN joins the user's PC or smartphone to the local network, via the secure tunnel. Another model for remote networking involves connecting to a host within the local network over a remote administration protocol. A protocol such as Secure Shell (SSH) traditionally provides terminal access, and there are many tools that can connect to a graphical desktop. A GUI remote administration tool sends screen and audio data from the remote host to the client and transfers mouse and keyboard input from the client to the remote host.

Microsoft's Remote Desktop Protocol (RDP) can be used to access a physical machine on a one-to-one basis. Alternatively, the site can operate a remote desktop gateway that facilitates access to virtual desktops or individual apps running on the network servers ([docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/welcome-to-rds](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/welcome-to-rds)). There are several popular alternatives to Remote Desktop. Most support remote access to platforms other than Windows (macOS and iOS, Linux, Chrome OS, and Android for instance). Examples include TeamViewer ([teamviewer.com/en](https://www.teamviewer.com/en/)) and Virtual Network Computing (VNC), which is implemented by several different providers (notably [realvnc.com/en](https://www.realvnc.com/en/)).

Traditionally, these remote desktop products require a client app. The canvas element introduced in HTML5 allows a browser to draw and update a desktop with relatively little lag. It can also handle audio. This is referred to as an HTML5 VPN or as a clientless remote desktop gateway ([guacamole.apache.org](https://guacamole.apache.org/)). This solution also uses a protocol called WebSockets, which enables bidirectional messages to be sent between the server and client without requiring the overhead of separate HTTP requests.

## OUT-OF-BAND MANAGEMENT AND JUMP SERVERS

Remote access management refers to the specific use case of using a secure channel to administer a network appliance or server. The secure admin workstations (SAWs) used to perform management functions must be tightly locked down, ideally installed with no software other than that required to access the administrative channel—minimal web browser, remote desktop client, or SSH virtual terminal, for instance. SAWs should be denied Internet access or be restricted to a handful of approved vendor sites (for patches, drivers, and support). The devices must also be subject to stringent access control and auditing so that any misuse is detected at the earliest opportunity.

#### Out-of-Band Management <a href="#c30429c3-11fe-458b-8294-fc6cc58d6d08" id="c30429c3-11fe-458b-8294-fc6cc58d6d08"></a>

Remote management methods can be described as either in-band or out-of-band (OOB). An in-band management link is one that shares traffic with other communications on the "production" network. A serial console or modem port on a router is a physically out-of-band management method. When using a browser-based management interface or a virtual terminal over Ethernet and IP, the link can be made out-of-band by connecting the port used for management access to physically separate network infrastructure. This can be costly to implement, but out-of-band management is more secure and means that access to the device is preserved when there are problems affecting the production network. With an in-band connection, better security can be implemented by using a VLAN to isolate management traffic. This makes it harder for potential eavesdroppers to view or modify traffic passing over the management interface. This sort of virtual OOB does still mean that access could be compromised by a system-wide network failure, however.

#### Jump Servers <a href="#e21d9545-c7c4-4f14-a8e3-cc81bc65216e" id="e21d9545-c7c4-4f14-a8e3-cc81bc65216e"></a>

One of the challenges of managing hosts that are exposed to the Internet, such as servers and appliances in a DMZ, is to provide administrative access to them. Accessing these individual hosts directly from a secure zone may open their administrative interfaces to exploitation and be used as a pivot point back into the internal network. Consequently, the administrative servers in the secure zone that are permitted to access hosts in the DMZ must be tightly controlled. Configuring and auditing this type of control when there are many different servers operating in both zones is complex.

One solution to this complexity is to add a single administration server, or jump server, to the secure zone. The jump server only runs the necessary administrative port and protocol (typically SSH or RDP). Administrators connect to the jump server then use the jump server to connect to the admin interface on the application server. The application server's admin interface has a single entry in its ACL (the jump server) and denies connection attempts from any other hosts.

1\. Remote Management

A jump server facilitates remote connections (over a secure VPN) by concentrating traffic to a single hardened host. The jump server runs only the management protocol (SSH or RDP) and forwards authorized connections to the relevant app server.

While this example topology represents an on-premises DMZ, the same sort of architecture can be used for secure management of hosts in the cloud.

2\. Local Management

A jump server can also be deployed when hosts on the intranet are used to manage hosts in a DMZ.

As well as the jump server, it is important to ensure that only hardened clients are allowed management access. These clients can be referred to as secure administrative workstations (SAWs).

3\. Filtering Unauthorized Hosts

Authentication and access control must be used to only allow valid users and hardened management hosts to access the management channel.

4\. App Server Security

On the app servers, the management protocol configuration or host firewall should only allow connections from the jump host.

SECURE SHELL

Secure Shell (SSH) is the principal means of obtaining secure remote access to a command line terminal. The main uses of SSH are for remote administration and secure file transfer (SFTP). There are numerous commercial and open source SSH products available for all the major network operating system (NOS) platforms. The most widely used is OpenSSH ([openssh.com](https://www.openssh.com/)).

SSH servers are identified by a public/private key pair (the host key). A mapping of host names to public keys can be kept manually by each SSH client or there are various enterprise software products designed for SSH host key management.

The host key must be changed if any compromise of the host is suspected. If an attacker has obtained the private key of a server or appliance, they can masquerade as that server or appliance and perform a man-in-the-middle attack, usually with a view to obtaining other network credentials.

The server's host key is used to set up a secure channel to use for the client to submit authentication credentials.

#### SSH Client Authentication <a href="#id-0849ec20-fbbe-424d-b70f-64a46ef06c87" id="id-0849ec20-fbbe-424d-b70f-64a46ef06c87"></a>

SSH allows various methods for the client to authenticate to the SSH server. Each of these methods can be enabled or disabled as required on the server, using the /etc/ssh/sshd\_config file:

* Username/password—the client submits credentials that are verified by the SSH server either against a local user database or using a RADIUS/TACACS+ server.
* Public key authentication—each remote user's public key is added to a list of keys authorized for each local account on the SSH server.
* Kerberos—the client submits a Ticket Granting Ticket (TGT) to the Ticket Granting Service (TGS) along with the Service Principal Name (SPN) of the SSH server that the client wants to access. The Key Distribution Center (KDC) verifies the TGT of the client to authorize access. The TGS then sends a valid session key to the client that can be forwarded to the SSH server to prove identity and gain access.

Managing valid client public keys is a critical security task. Many recent attacks on web servers have exploited poor key management. If a user's private key is compromised, delete the public key from the appliance then regenerate the key pair on the user's (remediated) client device and copy the public key to the SSH server. Always delete public keys if the user's access permissions have been revoked.

#### SSH Commands <a href="#id-69b39e47-83d4-40e3-9806-aef984790562" id="id-69b39e47-83d4-40e3-9806-aef984790562"></a>

SSH commands are used to connect to hosts and set up authentication methods. To connect to an SSH server at 10.1.0.10 using an account named "bobby" and password authentication, run:

ssh bobby@10.1.0.10

The following commands create a new key pair and copy it to an account on the remote server:

ssh-keygen -t rsa

ssh-copy-id bobby@10.1.0.10

At an SSH prompt, you can now use the standard Linux shell commands. Use exit to close the connection.

You can also use the scp command to copy a file from the remote server to the local host:

scp bobby@10.1.0.10:/logs/audit.log audit.log

Reverse the arguments to copy a file from the local host to the remote server. To copy the contents of a directory and any subdirectories (recursively), use the -r option.

\\
