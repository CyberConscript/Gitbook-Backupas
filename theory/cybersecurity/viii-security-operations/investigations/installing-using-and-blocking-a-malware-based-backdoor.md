# Installing, Using, and Blocking a Malware-based Backdoor

## Scenario <a href="#scenario" id="scenario"></a>

In this activity, you will disable Windows Defender, leaving a server vulnerable. You will then simulate the accidental installation of malware and view the changes. You will take on the role of a pen tester or hacker, and determine whether the malware was installed based on open network ports. Next, you'll connect to the infected server, proving you having the ability to exploit it. Finally, in the role of security administrator, you will remove the malware.



## Disable Windows Defender <a href="#disable-windows-defender" id="disable-windows-defender"></a>

In the first part of this activity, you will disable Windows Defender protection, leaving the server vulnerable to malware.

1. &#x20;Select the [MS1](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) VM, select [Ctrl+Alt+Delete](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10), then at the login screen, in the Password box, type Pa\$$w0rd and press **ENTER**.
2. &#x20;Select **Start**, and right-click **Windows PowerShell** and select **Run as Administrator**.
3. &#x20;When prompted, select **Yes** to confirm the UAC.
4.  &#x20;Type the following command, then press **ENTER**:

    ```
    Set-MpPreference -DisableRealTimeMonitoring $True
    ```

    This PowerShell cmdlet disables Windows Defender online scanning.
5. &#x20;Close the PowerShell window.

## Install program from Odysseus.iso <a href="#install-program-from-odysseusiso" id="install-program-from-odysseusiso"></a>

Pretend that you are installing the program on the Odysseus.iso disc image, thinking that it is a legitimate piece of software. Insert the disc image and use its autoplay settings to start the installation.

1. &#x20;Select [ODYSSEUS](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) to load the ISO image in the current VM.
2.  &#x20;In the [MS1](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) VM window, click the notification and then select **Run setup.exe** (it may take up to one minute for the notification to appear).

    > If you don't see the notification pop-up, right click on Start, Run and type **d:\setup.exe** then Enter.

    A User Account Control (UAC) warning is shown because a setup.exe process is trying to execute. The process' image file is unsigned (the publisher is listed as unknown).
3. &#x20;If necessary, select **Show more details**. Note that the install script is set to run in silent mode.
4. &#x20;You would not normally proceed, but for this activity, select **Yes**.
5. &#x20;The installer runs silently, with no visible window. When installation is complete, you will see two new icons on the desktop. Open either of the **SimpleHash** or **SimpleSalter** shortcuts from the desktop.
6. &#x20;Close the utility window.



## Identify network ports <a href="#identify-network-ports" id="identify-network-ports"></a>

The Odysseus software has installed a backdoor application called Netcat on the computer. This runs with the privileges of the logged-on user (currently Administrator) and allows a remote machine to access the command prompt on MS1. Use the DC1 VM to run a posture assessment and see if the backdoor can be discovered. To discover the port that the backdoor is listening on, you can use a network scanner called **Angry IP Scanner** ([angryip.org](http://angryip.org)).

1. &#x20;Switch to the [DC1](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) VM.
2. &#x20;Click [Ctrl+Alt+Delete](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) to send the Ctrl+Alt+Delete sequence to the VM and show the login page. Sign in as 515support\Administrator using Pa\$$w0rd as the password.
3. &#x20;From the desktop, open the **AngryIP** shortcut.
4. &#x20;In the IP Range: boxes type `10.1.0.2` (you will do this in both boxes) to target the **MS1** virtual machine.
5. &#x20;Select the **Preferences** icon to open the Preferences dialog box.
6. &#x20;Select the **Ports** tab and enter `1-1024,4400-4500` in the Port selection box. Select **OK**.
7.  &#x20;Select **Start** to begin the scan.

    The scan takes about one minute.
8. &#x20;When the scan is complete, select **Close**.
9. &#x20;Look at the open ports on the MS1 VM—how many of them can you identify?
10. Which port is associated with the trojan?

    22804434454450



## Test backdoor <a href="#test-backdoor" id="test-backdoor"></a>

To connect to the backdoor on MS1, you will use a terminal emulation client called **PuTTY** ([chiark.greenend.org.uk](https://www.chiark.greenend.org.uk/\~sgtatham/putty/latest.html)).

1. &#x20;On the [DC1](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) VM, double-click the **PuTTY** icon in the **LABFILES** folder.
2. &#x20;In the Host name (or IP address) box, type `10.1.0.2`. In the Port box, enter `4450`. Set the Connection type to **Raw**.
3. &#x20;In the Saved Sessions box, type `MS1` then select the **Save** button.
4.  &#x20;Select **Open**. After a few seconds, you will be connected to the command prompt on MS1.

    > If the connection does not display a **C:\\** prompt, it is not successful. Confirm the above steps in the following order: 1) Defender is disabled, 2) Port 4450 is specified in Putty (as is the correct IP address of 10.1.0.2 and connect type: RAW)
5.  &#x20;In the putty terminal window, run the following three commands to confirm your remote connection:

    `whoami`

    `hostname`

    `ipconfig`
6.  &#x20;Run the following command to create a user account named **mal** on the remote server:

    `net user /add mal Pa$$w0rd`
7. Confirm that the "mal" local user account exists.

*   > Many of your tasks are scored by scripts. You must use the same names and other labels as the lab instructions specify or your task may be marked as incorrect. For example, if the task says to create a user account named “user01,” than “user1” would be marked as incorrect.

    > Practice typing in the commands manually to help you learn and remember the syntax.
*   &#x20;Run the following command to add the **mal** user to the local administrators group:

    `net localgroup administrators mal /add`
* Confirm that user "mal" is a member of the local administrators group.
* Creating a user account is one way for a threat actor to establish a persistence mechanism and re-connect to the target network or host.
* &#x20;Leave the **PuTTY** window open.







### Block backdoor <a href="#block-backdoor" id="block-backdoor"></a>

Use Task Manager and the Windows Defender to investigate the changes that the Trojan has made.

1.  &#x20;Switch to the [MS1](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) VM and, if necessary, use [Ctrl+Alt+Delete](https://labclient.labondemand.com/Instructions/1cc33502-0221-499c-8cec-b1f68f299886?rc=10) to sign back in as 515support\Administrator with password Pa\$$w0rd.

    > If a Windows Script Host error appears, click **OK**. There may also be a Windows Defender notification.
2. &#x20;Using **File Explorer**, browse to `C:\Program Files (x86)\Odysseus` and note the ini.vbs file.
3. &#x20;Open **ini.vbs** in Notepad (right-click and select **Edit**). Note the actions that the script performs.
4. &#x20;Close the script file, and then use **File Explorer** to delete it.
5. &#x20;Open **Task Manager**.
6.  &#x20;Select the **Processes** tab in **Task Manager**, and then right-click on the **ncat (32 bit)** process and select **End task**.

    > You can alphabetize the process list by clicking the _Name_ column at the top.
7. &#x20;Close **Task Manager**.
8. &#x20;Select **Start** then type `firewall with advanced security` and open the **Windows Defender Firewall with Advanced Security** link that appears.
9. &#x20;Select the **Inbound Rules** node. Can you spot anything unusual that might be related to the **ncat** backdoor that was installed?
10. What is the name of the firewall rule associated with the trojan?

    PuTTYRule 42Service Portncatnetcat

* Correct
* &#x20;Disable the rule added by the Trojan by right-clicking it and selecting **Disable Rule**.
* Confirm that the firewall blocks connections over port 4450.
*
*   Confirm that you have deleted the ini.vbs file.

    Correct
*
*   Confirm that the malware has been removed by verifying that ncat.exe is no longer running in the process list.

    No MSFT\_NetFirewallRule objects found with property 'DisplayName' equal to 'Service Port'. Verify the value of the property and retry.

<details>

<summary>Remove the malware</summary>

If one or more of the above check fails, repeat the steps to ensure that you deleted the .ini file, stopped the netcat (32 bit) process, and disabled the firewall rule pertaining to the Service Port.

</details>

This Trojan is trivially easy to block and remove, but most malware is more sophisticated.
